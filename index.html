<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Durham Athletic FC â€“ Career Hub</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f5c542">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#0b1f3a;color:#fff;padding:20px}
h1,h2{color:#f5c542}
button{padding:8px 12px;margin:4px;font-weight:bold}
table{width:100%;border-collapse:collapse;background:#fff;color:#000;margin-bottom:20px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
input,select{width:100%}
.locked{opacity:.6}
canvas{background:#fff;padding:10px;margin-bottom:20px}
small{opacity:.7}
</style>
</head>

<body>

<h1>ğŸ¦… Durham Athletic FC â€“ Career Hub</h1>

<button onclick="saveDB()">ğŸ’¾ Guardar</button>
<button onclick="backupDB()">ğŸ“¦ Backup</button>
<input type="file" onchange="restoreDB(event)">
<button onclick="duplicateSeason()">ğŸ“‹ Nueva temporada</button>
<button onclick="closeSeason()">ğŸ”’ Finalizar temporada</button>
<button onclick="exportPDF()">ğŸ“„ Exportar PDF</button>
<button onclick="resetDB()">ğŸ—‘ï¸ Reset</button>
<div id="saveStatus" style="opacity:.7;margin:6px 0;"></div>

<h2>ğŸ“Š EstadÃ­sticas</h2>
<button onclick="addStat()">â• AÃ±adir jugador</button>

<table id="statsTable">
<tr>
<th>Temp</th><th>Jugador</th><th>Pos</th>
<th>PJ</th><th>G</th><th>A</th><th>CS</th>
<th>Media</th><th>Valor (Â£M)</th>
</tr>
</table>

<h2>ğŸ” Traspasos</h2>
<button onclick="addTransfer()">â• AÃ±adir</button>
<table id="transfersTable">
<tr>
<th>Temp</th><th>Jugador</th><th>Dir</th><th>Tipo</th><th>Club</th><th>Precio</th>
</tr>
</table>

<h2>ğŸ† PalmarÃ©s</h2>
<button onclick="addTrophy()">â• AÃ±adir</button>
<table id="trophiesTable">
<tr>
<th>Temp</th><th>CompeticiÃ³n</th><th>Resultado</th><th>Jugadores</th>
</tr>
</table>

<h2>â­ Jugador de la Temporada</h2>
<button onclick="addAward()">â• AÃ±adir</button>
<table id="awardsTable">
<tr><th>Temp</th><th>Jugador</th><th>Motivo</th></tr>
</table>

<h2>ğŸ“ˆ RÃ©cords del Club</h2>
<ul id="records"></ul>

<h2>ğŸ† Rankings HistÃ³ricos (TOP 10)</h2>
<table id="rankG"></table>
<table id="rankA"></table>
<table id="rankCS"></table>
<table id="rankPJ"></table>
<table id="rankTrophies"></table>

<h2>ğŸ“Š EconomÃ­a</h2>
<select id="chartPlayer" onchange="drawPlayerChart()"></select>
<canvas id="playerChart" height="120"></canvas>
<canvas id="clubChart" height="120"></canvas>

<h2>ğŸ›ï¸ Hall of Fame</h2>
<ul id="hof"></ul>

<script>

/* ====================== BASE DE DATOS ====================== */
let DB = JSON.parse(localStorage.DB || JSON.stringify({
 stats:[],
 transfers:[],
 trophies:[],
 awards:[],
 closedSeasons:{},
 hofDates:{}
}));

const playerChartCanvas = document.getElementById("playerChart");
const clubChartCanvas = document.getElementById("clubChart");

/* ====================== CONFIG HOF ====================== */
const HOF_RULES = {
 field: {
  seasons: 5,      // temporadas jugadas
  pj: 200,         // partidos
  goals: 100,      // goles
  assists: 70,     // asistencias
  trophies: 5      // tÃ­tulos
 },
 gk: {
  seasons: 5,
  pj: 180,
  cleanSheets: 60,
  trophies: 5
 }
};

/* ====================== UTIL ====================== */
function saveDB(){localStorage.DB = JSON.stringify(DB);showSaved();}
function resetDB(){ if(confirm("Â¿Borrar todo?")){localStorage.clear();location.reload();} }

/* ====================== STATS ====================== */
function addStat(data={}){
 DB.stats.push(Object.assign({
  season:"",name:"",pos:"",
  pj:0,g:0,a:0,cs:0,media:0,value:0
 },data));
 render();
}

function renderStats(){
 statsTable.innerHTML=statsTable.rows[0].outerHTML;
 DB.stats.forEach((s,i)=>{
  let r=statsTable.insertRow();
  Object.values(s).forEach((v,j)=>{
   let c=r.insertCell();
   c.innerHTML=`<input value="${v}" ${DB.closedSeasons[s.season]?"readonly":""}
    oninput="DB.stats[${i}]['${Object.keys(s)[j]}']=this.value; recalc()">`;
  });
  if(DB.closedSeasons[s.season]) r.classList.add("locked");
 });
}

/* ====================== TRANSFERS ====================== */
function addTransfer(){
 DB.transfers.push({season:"",name:"",dir:"Entrante",type:"Traspaso",club:"",price:0});
 render();
}

function renderTransfers(){
 transfersTable.innerHTML=transfersTable.rows[0].outerHTML;
 DB.transfers.forEach((t,i)=>{
  let r=transfersTable.insertRow();
  r.innerHTML=`
   <td><input value="${t.season}" oninput="DB.transfers[${i}].season=this.value; recalc()"></td>
   <td><input value="${t.name}" oninput="DB.transfers[${i}].name=this.value; recalc()"></td>
   <td><select onchange="DB.transfers[${i}].dir=this.value">
    <option ${t.dir=="Entrante"?"selected":""}>Entrante</option>
    <option ${t.dir=="Saliente"?"selected":""}>Saliente</option>
   </select></td>
   <td><select onchange="DB.transfers[${i}].type=this.value">
    <option>Traspaso</option><option>CesiÃ³n</option>
   </select></td>
   <td><input value="${t.club}" oninput="DB.transfers[${i}].club=this.value"></td>
   <td><input type="number" value="${t.price}" oninput="DB.transfers[${i}].price=this.value"></td>`;
 });
}

/* ====================== TROPHIES ====================== */
function addTrophy(){
 DB.trophies.push({season:"",comp:"",res:"",players:""});
 render();
}

function renderTrophies(){
 trophiesTable.innerHTML=trophiesTable.rows[0].outerHTML;
 DB.trophies.forEach((t,i)=>{
  let r=trophiesTable.insertRow();
  r.innerHTML=`
   <td><input value="${t.season}" oninput="DB.trophies[${i}].season=this.value; recalc()"></td>
   <td><input value="${t.comp}" oninput="DB.trophies[${i}].comp=this.value"></td>
   <td><input value="${t.res}" oninput="DB.trophies[${i}].res=this.value"></td>
   <td><input value="${t.players}" oninput="DB.trophies[${i}].players=this.value; recalc()"></td>`;
 });
}

/* ====================== AWARDS ====================== */
function addAward(){
 DB.awards.push({season:"",name:"",reason:""});
 render();
}

function renderAwards(){
 awardsTable.innerHTML=awardsTable.rows[0].outerHTML;
 DB.awards.forEach((a,i)=>{
  let r=awardsTable.insertRow();
  r.innerHTML=`
   <td><input value="${a.season}" oninput="DB.awards[${i}].season=this.value"></td>
   <td><input value="${a.name}" oninput="DB.awards[${i}].name=this.value"></td>
   <td><input value="${a.reason}" oninput="DB.awards[${i}].reason=this.value"></td>`;
 });
}

/* ====================== TEMPORADAS ====================== */
function duplicateSeason(){
 let seasons=[...new Set(DB.stats.map(s=>s.season))].filter(Boolean);
 let last=seasons.sort().slice(-1)[0];
 let next=prompt("Nueva temporada:", "");
 if(!next) return;
 DB.stats.filter(s=>s.season===last).forEach(s=>{
  addStat({...s,season:next,pj:0,g:0,a:0,cs:0});
 });
}

function closeSeason(){
 let s=prompt("Temporada a cerrar:");
 if(s){DB.closedSeasons[s]=true; saveDB(); render();}
}

/* ====================== RECÃLCULO ====================== */
let clubChart,playerChart;

function recalc(){
 let P={},titles={};
 DB.stats.forEach(s=>{
  if(!P[s.name]) P[s.name]={pj:0,g:0,a:0,cs:0,val:0,pos:s.pos};
  P[s.name].pj+=+s.pj;
  P[s.name].g+=+s.g;
  P[s.name].a+=+s.a;
  if(s.pos==="POR") P[s.name].cs+=+s.cs;
  P[s.name].val=Math.max(P[s.name].val,+s.value);
 });

 DB.trophies.forEach(t=>{
  t.players.split(",").forEach(p=>{
   if(p.trim()) titles[p.trim()]=(titles[p.trim()]||0)+1;
  });
 });

 buildRecords(P,titles);
 buildRanks(P);
 buildCharts(P);
 buildHOF(P,titles);
 autosave();
}

/* ====================== RECORDS / RANKINGS ====================== */
function buildRecords(P,t){
 records.innerHTML="";

 // HISTÃ“RICOS
 let maxHist = k => Object.entries(P).sort((a,b)=>b[1][k]-a[1][k])[0];
 records.innerHTML += `<li><b>RÃ©cords histÃ³ricos</b></li>`;
 ["g","a","cs","pj"].forEach(k=>{
  let m = maxHist(k);
  if(m) records.innerHTML+=`<li>${k.toUpperCase()}: ${m[0]} (${m[1][k]})</li>`;
 });

 // TEMPORADA
 let seasonRecords = {
  g:{v:0,n:"",s:""},
  a:{v:0,n:"",s:""},
  cs:{v:0,n:"",s:""}
 };

 DB.stats.forEach(s=>{
  if(+s.g > seasonRecords.g.v){
   seasonRecords.g = {v:+s.g,n:s.name,s:s.season};
  }
  if(+s.a > seasonRecords.a.v){
   seasonRecords.a = {v:+s.a,n:s.name,s:s.season};
  }
  if(s.pos==="POR" && +s.cs > seasonRecords.cs.v){
   seasonRecords.cs = {v:+s.cs,n:s.name,s:s.season};
  }
 });

 records.innerHTML += `<li><b>RÃ©cords en una temporada</b></li>`;
 records.innerHTML += `<li>âš½ Goles: ${seasonRecords.g.n} (${seasonRecords.g.v}) â€“ ${seasonRecords.g.s}</li>`;
 records.innerHTML += `<li>ğŸ¯ Asistencias: ${seasonRecords.a.n} (${seasonRecords.a.v}) â€“ ${seasonRecords.a.s}</li>`;
 records.innerHTML += `<li>ğŸ§¤ PorterÃ­as imbatidas: ${seasonRecords.cs.n} (${seasonRecords.cs.v}) â€“ ${seasonRecords.cs.s}</li>`;
}


function buildRanks(P){
 makeRank(rankG,P,"g","Goles");
 makeRank(rankA,P,"a","Asistencias");
 makeRank(rankCS,P,"cs","PorterÃ­as imbatidas");
 makeRank(rankPJ,P,"pj","Partidos jugados");
 buildTrophyRank();
}

function makeRank(el,P,k,l){
 el.innerHTML=`<tr><th>#</th><th>Jugador</th><th>${l}</th></tr>`;
 Object.entries(P).sort((a,b)=>b[1][k]-a[1][k]).slice(0,10)
 .forEach((e,i)=>el.innerHTML+=`<tr><td>${i+1}</td><td>${e[0]}</td><td>${e[1][k]}</td></tr>`);
}

function buildTrophyRank(){
 rankTrophies.innerHTML =
  "<tr><th>#</th><th>Jugador</th><th>TÃ­tulos</th></tr>";

 const count = {};
 DB.trophies.forEach(t=>{
  t.players.split(",").forEach(p=>{
   if(p.trim()) count[p.trim()] = (count[p.trim()]||0) + 1;
  });
 });

 Object.entries(count)
  .sort((a,b)=>b[1]-a[1])
  .slice(0,10)
  .forEach((e,i)=>{
   rankTrophies.innerHTML +=
    `<tr><td>${i+1}</td><td>${e[0]}</td><td>${e[1]}</td></tr>`;
  });
}

/* ====================== GRÃFICAS ====================== */
function buildCharts(P){
 chartPlayer.innerHTML="<option>Jugador</option>";
 Object.keys(P).forEach(n=>chartPlayer.innerHTML+=`<option>${n}</option>`);
 if(clubChart) clubChart.destroy();
 clubChart=new Chart(clubChartCanvas,{
  type:"bar",
  data:{labels:Object.keys(P),datasets:[{label:"Valor mÃ¡ximo (Â£M)",data:Object.values(P).map(p=>p.val)}]}
 });
}

function drawPlayerChart(){
 let n=chartPlayer.value;
 let s=[],v=[];
 DB.stats.filter(x=>x.name===n).forEach(x=>{s.push(x.season);v.push(x.value);});
 if(playerChart) playerChart.destroy();
 playerChart=new Chart(playerChartCanvas,{
  type:"line",
  data:{labels:s,datasets:[{label:n,data:v}]}
 });
}

/* ====================== HALL OF FAME ====================== */
function buildHOF(P, trophies){
 hof.innerHTML = "";

 Object.entries(P).forEach(([name, d]) => {

  const seasons = new Set(
   DB.stats.filter(s => s.name === name).map(s => s.season)
  ).size;

  const t = trophies[name] || 0;
  let reasons = [];
  let score = 0;

  if (d.pos === "POR") {

   if (seasons >= HOF_RULES.gk.seasons) { score++; reasons.push("Temporadas"); }
   if (d.pj >= HOF_RULES.gk.pj) { score++; reasons.push("Partidos"); }
   if (d.cs >= HOF_RULES.gk.cleanSheets) { score++; reasons.push("PorterÃ­as a 0"); }
   if (t >= HOF_RULES.gk.trophies) { score++; reasons.push("TÃ­tulos"); }

  } else {

   if (seasons >= HOF_RULES.field.seasons) { score++; reasons.push("Temporadas"); }
   if (d.pj >= HOF_RULES.field.pj) { score++; reasons.push("Partidos"); }
   if (d.g >= HOF_RULES.field.goals) { score++; reasons.push("Goles"); }
   if (d.a >= HOF_RULES.field.assists) { score++; reasons.push("Asistencias"); }
   if (t >= HOF_RULES.field.trophies) { score++; reasons.push("TÃ­tulos"); }
  }

  if (score >= 4) {
   if (!DB.hofDates[name]) DB.hofDates[name] = new Date().toLocaleDateString();

   hof.innerHTML += `
    <li title="${reasons.join(", ")}">
     â­ <b>${name}</b>
     <small>(${reasons.join(", ")}) â€“ Entrada: ${DB.hofDates[name]}</small>
    </li>`;
  }

 });
}

/* ====================== PDF ====================== */
function exportPDF(){
 const pdf=new jspdf.jsPDF();
 let y=10;
 pdf.text("Durham Athletic FC â€“ Historia del Club",10,y); y+=10;
 document.querySelectorAll("#records li").forEach(li=>{pdf.text(li.innerText,10,y); y+=6;});
 pdf.save("Durham_AFC_Resumen.pdf");
}

/* ====================== RENDER ====================== */
function render(){
 renderStats();
 renderTransfers();
 renderTrophies();
 renderAwards();
 recalc();
}

render();

if ("serviceWorker" in navigator) {
 navigator.serviceWorker.register("./sw.js");
}

let saveTimeout;
function showSaved(){
 clearTimeout(saveTimeout);
 const el = document.getElementById("saveStatus");
 el.textContent = "ğŸ’¾ Guardado";
 saveTimeout = setTimeout(()=>el.textContent="",1500);
}

let autosaveTimer;
function autosave(){
 clearTimeout(autosaveTimer);
 autosaveTimer = setTimeout(saveDB, 500);
}

</script>

</body>

</html>
